<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>3D –ü–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫: –û–±–ª–∞—á–Ω–∞—è –≤–µ—Ä—Å–∏—è</title>
    
    <!-- React –∏ ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Three.js (–¥–ª—è 3D) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>
    
    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, doc, setDoc, addDoc, deleteDoc, onSnapshot, serverTimestamp, query, orderBy } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // –ì–ª–æ–±–∞–ª—å–Ω–∞—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Firebase, —á—Ç–æ–±—ã React –º–æ–≥ –µ—ë –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å
        window.initFirebase = async () => {
             // –ò—Å–ø–æ–ª—å–∑—É–µ–º –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é –∏–∑ —Å—Ä–µ–¥—ã –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è
            const firebaseConfig = JSON.parse(window.__firebase_config || '{}');
            const appId = window.__app_id || 'default-app';
            
            if (!firebaseConfig.apiKey) {
                console.warn("Firebase config not found. Local mode only.");
                return null;
            }

            const app = initializeApp(firebaseConfig);
            const auth = getAuth(app);
            const db = getFirestore(app);

            return { auth, db, appId, signInAnonymously, signInWithCustomToken, onAuthStateChanged, collection, doc, setDoc, addDoc, deleteDoc, onSnapshot, serverTimestamp, query, orderBy };
        };
    </script>

    <style>
        body { background-color: #f3f4f6; overflow: hidden; }
        .grid-pattern {
            background-image: 
                linear-gradient(#e5e7eb 1px, transparent 1px), 
                linear-gradient(90deg, #e5e7eb 1px, transparent 1px);
        }
        .no-select { user-select: none; -webkit-user-select: none; }
        /* –°–∫—Ä–æ–ª–ª–±–∞—Ä –¥–ª—è —Å–ø–∏—Å–∫–æ–≤ */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useRef, useEffect } = React;

        // --- –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ ---
        const getHexColor = (tailwindClass) => {
            if (tailwindClass.includes('red')) return 0xfca5a5;
            if (tailwindClass.includes('green')) return 0x86efac;
            if (tailwindClass.includes('blue')) return 0x93c5fd;
            if (tailwindClass.includes('slate')) return 0xcbd5e1;
            if (tailwindClass.includes('yellow')) return 0xfde047;
            return 0xcccccc;
        };

        const DEFAULT_SITE_CONFIG = { width: 24.5, height: 24.5 };
        const DEFAULT_OBJECTS = [
            { id: 'house', label: '–î–æ–º', w: 12, h: 10, height: 6, x: 3, y: 3, color: 'bg-red-100 border-red-500' },
            { id: 'cont1', label: '–•–æ–∑. –±–ª–æ–∫', w: 12.2, h: 2.44, height: 2.9, x: 12, y: 21, color: 'bg-green-100 border-green-500' },
            { id: 'parking', label: '–ü–∞—Ä–∫–æ–≤–∫–∞', w: 6, h: 5, height: 0.1, x: 18, y: 0.5, color: 'bg-slate-100 border-slate-400 border-dashed' }
        ];

        // --- –ö–æ–º–ø–æ–Ω–µ–Ω—Ç 3D –°—Ü–µ–Ω—ã (–±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π –ª–æ–≥–∏–∫–∏) ---
        const Scene3D = ({ objects, siteConfig }) => {
            const mountRef = useRef(null);
            const sceneRef = useRef(null);
            
            useEffect(() => {
                const width = mountRef.current.clientWidth;
                const height = mountRef.current.clientHeight;
                const scene = new THREE.Scene();
                scene.background = new THREE.Color(0xf0f9ff);
                scene.fog = new THREE.Fog(0xf0f9ff, 20, 100);
                sceneRef.current = scene;

                const camera = new THREE.PerspectiveCamera(45, width / height, 0.1, 1000);
                camera.position.set(siteConfig.width * 1.5, siteConfig.width, siteConfig.height * 1.5); 

                const renderer = new THREE.WebGLRenderer({ antialias: true });
                renderer.setSize(width, height);
                renderer.shadowMap.enabled = true;
                mountRef.current.appendChild(renderer.domElement);

                const controls = new THREE.OrbitControls(camera, renderer.domElement);
                controls.enableDamping = true;
                controls.maxPolarAngle = Math.PI / 2 - 0.05;

                const ambientLight = new THREE.AmbientLight(0xffffff, 0.6);
                scene.add(ambientLight);
                const dirLight = new THREE.DirectionalLight(0xffffff, 0.8);
                dirLight.position.set(20, 50, 20);
                dirLight.castShadow = true;
                dirLight.shadow.mapSize.width = 2048;
                dirLight.shadow.mapSize.height = 2048;
                scene.add(dirLight);

                const groundGeo = new THREE.PlaneGeometry(100, 100);
                const groundMat = new THREE.MeshStandardMaterial({ color: 0xe5e7eb });
                const ground = new THREE.Mesh(groundGeo, groundMat);
                ground.rotation.x = -Math.PI / 2;
                ground.position.y = -0.05;
                ground.receiveShadow = true;
                scene.add(ground);

                const plotGeo = new THREE.PlaneGeometry(siteConfig.width, siteConfig.height);
                const plotMat = new THREE.MeshStandardMaterial({ color: 0xf0fdf4, side: THREE.DoubleSide });
                const plot = new THREE.Mesh(plotGeo, plotMat);
                plot.rotation.x = -Math.PI / 2;
                plot.receiveShadow = true;
                scene.add(plot);

                const gridHelper = new THREE.GridHelper(Math.max(siteConfig.width, siteConfig.height), Math.max(siteConfig.width, siteConfig.height));
                scene.add(gridHelper);

                const animate = () => {
                    requestAnimationFrame(animate);
                    controls.update();
                    renderer.render(scene, camera);
                };
                animate();

                const handleResize = () => {
                    if (!mountRef.current) return;
                    const w = mountRef.current.clientWidth;
                    const h = mountRef.current.clientHeight;
                    camera.aspect = w / h;
                    camera.updateProjectionMatrix();
                    renderer.setSize(w, h);
                };
                window.addEventListener('resize', handleResize);

                return () => {
                    window.removeEventListener('resize', handleResize);
                    if (mountRef.current && renderer.domElement) mountRef.current.removeChild(renderer.domElement);
                    renderer.dispose();
                };
            }, []);

            useEffect(() => {
                if (!sceneRef.current) return;
                const scene = sceneRef.current;
                for (let i = scene.children.length - 1; i >= 0; i--) {
                    if (scene.children[i].userData.isBuilding) scene.remove(scene.children[i]);
                }
                objects.forEach(obj => {
                    const geometry = new THREE.BoxGeometry(obj.w, obj.height || 0.1, obj.h);
                    const material = new THREE.MeshStandardMaterial({ color: getHexColor(obj.color), roughness: 0.7, metalness: 0.1 });
                    const cube = new THREE.Mesh(geometry, material);
                    const centerX = obj.x + obj.w / 2 - siteConfig.width / 2;
                    const centerZ = obj.y + obj.h / 2 - siteConfig.height / 2;
                    cube.position.set(centerX, (obj.height || 0.1) / 2, centerZ);
                    cube.castShadow = true;
                    cube.receiveShadow = true;
                    cube.userData = { isBuilding: true };
                    const edges = new THREE.EdgesGeometry(geometry);
                    const line = new THREE.LineSegments(edges, new THREE.LineBasicMaterial({ color: 0x000000, opacity: 0.2, transparent: true }));
                    cube.add(line);
                    scene.add(cube);
                });
            }, [objects, siteConfig]);

            return <div ref={mountRef} className="w-full h-full cursor-move" />;
        };

        // --- –ì–ª–∞–≤–Ω–æ–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —Å Firebase ---
        const App = () => {
            const PIXELS_PER_METER = 20;

            // State UI
            const [viewMode, setViewMode] = useState('2d');
            const [selectedId, setSelectedId] = useState(null);
            const containerRef = useRef(null);

            // State Data
            const [siteConfig, setSiteConfig] = useState(DEFAULT_SITE_CONFIG);
            const [objects, setObjects] = useState(DEFAULT_OBJECTS);
            
            // Firebase State
            const [fb, setFb] = useState(null);
            const [user, setUser] = useState(null);
            const [projects, setProjects] = useState([]);
            const [currentProjectId, setCurrentProjectId] = useState(null);
            const [projectName, setProjectName] = useState("–ù–æ–≤—ã–π –ø—Ä–æ–µ–∫—Ç");
            const [isLoading, setIsLoading] = useState(true);
            const [saveStatus, setSaveStatus] = useState(""); // "saved", "saving", "modified"

            // 1. –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Firebase
            useEffect(() => {
                const init = async () => {
                    if (window.initFirebase) {
                        const fbInstance = await window.initFirebase();
                        if (fbInstance) {
                            setFb(fbInstance);
                            
                            // Auth Flow
                            const { auth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } = fbInstance;
                            
                            const authToken = window.__initial_auth_token;
                            if (authToken) {
                                await signInWithCustomToken(auth, authToken);
                            } else {
                                await signInAnonymously(auth);
                            }
                            
                            onAuthStateChanged(auth, (u) => setUser(u));
                        }
                    }
                    setIsLoading(false);
                };
                init();
            }, []);

            // 2. –ó–∞–≥—Ä—É–∑–∫–∞ —Å–ø–∏—Å–∫–∞ –ø—Ä–æ–µ–∫—Ç–æ–≤
            useEffect(() => {
                if (!user || !fb) return;
                const { db, appId, collection, onSnapshot, query, orderBy } = fb;

                // –ü—É—Ç—å: artifacts/{appId}/users/{uid}/designs
                const q = query(collection(db, 'artifacts', appId, 'users', user.uid, 'designs')); // orderBy —Ç—Ä–µ–±—É–µ—Ç –∏–Ω–¥–µ–∫—Å–∞, –ø–æ–∫–∞ –±–µ–∑ –Ω–µ–≥–æ –¥–ª—è –ø—Ä–æ—Å—Ç–æ—Ç—ã

                const unsubscribe = onSnapshot(q, (snapshot) => {
                    const loadedProjects = snapshot.docs.map(doc => ({
                        id: doc.id,
                        ...doc.data()
                    }));
                    
                    // –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –Ω–∞ –∫–ª–∏–µ–Ω—Ç–µ
                    loadedProjects.sort((a, b) => (b.updatedAt?.seconds || 0) - (a.updatedAt?.seconds || 0));
                    
                    setProjects(loadedProjects);

                    // –ï—Å–ª–∏ –ø—Ä–æ–µ–∫—Ç–æ–≤ –Ω–µ—Ç, —Å–æ–∑–¥–∞–µ–º –ø–µ—Ä–≤—ã–π –¥–µ—Ñ–æ–ª—Ç–Ω—ã–π (–µ—Å–ª–∏ –Ω–µ –∑–∞–≥—Ä—É–∂–∞–µ–º—Å—è)
                    if (loadedProjects.length === 0 && !currentProjectId) {
                        // –õ–æ–≥–∏–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –ø–µ—Ä–≤–æ–≥–æ –ø—Ä–æ–µ–∫—Ç–∞ –±—É–¥–µ—Ç –≤—ã–∑–≤–∞–Ω–∞ –≤—Ä—É—á–Ω—É—é –∏–ª–∏ —é–∑–µ—Ä–æ–º
                    } else if (loadedProjects.length > 0 && !currentProjectId) {
                        // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ—Ç–∫—Ä—ã—Ç—å –ø–æ—Å–ª–µ–¥–Ω–∏–π –∏–∑–º–µ–Ω–µ–Ω–Ω—ã–π
                        loadProject(loadedProjects[0]);
                    }
                }, (error) => {
                    console.error("Error fetching projects:", error);
                });

                return () => unsubscribe();
            }, [user, fb]); // currentProjectId –∏—Å–∫–ª—é—á–µ–Ω, —á—Ç–æ–±—ã –Ω–µ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞—Ç—å —Å–ø–∏—Å–æ–∫ –ø—Ä–∏ —Å–º–µ–Ω–µ –ø—Ä–æ–µ–∫—Ç–∞

            // --- –§—É–Ω–∫—Ü–∏–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø—Ä–æ–µ–∫—Ç–∞–º–∏ ---

            const createNewProject = async () => {
                if (!user || !fb) return;
                const { db, appId, collection, addDoc, serverTimestamp } = fb;

                const newProject = {
                    name: `–ü—Ä–æ–µ–∫—Ç ${projects.length + 1}`,
                    siteConfig: DEFAULT_SITE_CONFIG,
                    objects: DEFAULT_OBJECTS,
                    updatedAt: serverTimestamp()
                };

                try {
                    const docRef = await addDoc(collection(db, 'artifacts', appId, 'users', user.uid, 'designs'), newProject);
                    setCurrentProjectId(docRef.id);
                    setProjectName(newProject.name);
                    setSiteConfig(newProject.siteConfig);
                    setObjects(newProject.objects);
                    setSaveStatus("saved");
                } catch (e) {
                    console.error("Error creating project:", e);
                }
            };

            const loadProject = (project) => {
                setCurrentProjectId(project.id);
                setProjectName(project.name);
                setSiteConfig(project.siteConfig || DEFAULT_SITE_CONFIG);
                setObjects(project.objects || []);
                setSaveStatus("saved");
                setSelectedId(null);
            };

            const saveProject = async () => {
                if (!user || !fb || !currentProjectId) return;
                setSaveStatus("saving");
                const { db, appId, doc, setDoc, serverTimestamp } = fb;

                try {
                    await setDoc(doc(db, 'artifacts', appId, 'users', user.uid, 'designs', currentProjectId), {
                        name: projectName,
                        siteConfig: siteConfig,
                        objects: objects,
                        updatedAt: serverTimestamp()
                    }, { merge: true });
                    setSaveStatus("saved");
                    setTimeout(() => setSaveStatus(""), 2000);
                } catch (e) {
                    console.error("Error saving:", e);
                    setSaveStatus("error");
                }
            };

            const deleteProject = async (id, e) => {
                e.stopPropagation();
                if (!confirm("–£–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç –ø—Ä–æ–µ–∫—Ç –Ω–∞–≤—Å–µ–≥–¥–∞?")) return;
                
                if (!user || !fb) return;
                const { db, appId, doc, deleteDoc } = fb;

                try {
                    await deleteDoc(doc(db, 'artifacts', appId, 'users', user.uid, 'designs', id));
                    if (id === currentProjectId) {
                        // –ï—Å–ª–∏ —É–¥–∞–ª–∏–ª–∏ —Ç–µ–∫—É—â–∏–π, —Å–±—Ä–∞—Å—ã–≤–∞–µ–º
                        setCurrentProjectId(null);
                        setProjectName("");
                        setObjects([]);
                    }
                } catch (err) {
                    console.error("Error deleting:", err);
                }
            };

            // –û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏–π –¥–ª—è —Å—Ç–∞—Ç—É—Å–∞ "–ù–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ"
            useEffect(() => {
                if (currentProjectId && saveStatus !== "saving") {
                    setSaveStatus("modified");
                }
            }, [objects, siteConfig, projectName]);


            // --- –õ–æ–≥–∏–∫–∞ Drag & Drop (—Ç–∞ –∂–µ —Å–∞–º–∞—è) ---
            const [draggingId, setDraggingId] = useState(null);
            const [offset, setOffset] = useState({ x: 0, y: 0 });

            const handleStart = (clientX, clientY, id, e) => {
                if (viewMode === '3d') return;
                if(e && e.stopPropagation) e.stopPropagation();
                setDraggingId(id);
                setSelectedId(id);
                const obj = objects.find(o => o.id === id);
                const rect = containerRef.current.getBoundingClientRect();
                const mouseX = (clientX - rect.left) / PIXELS_PER_METER;
                const mouseY = (clientY - rect.top) / PIXELS_PER_METER;
                setOffset({ x: mouseX - obj.x, y: mouseY - obj.y });
            };

            const handleMove = (clientX, clientY) => {
                if (!draggingId || viewMode === '3d') return;
                const rect = containerRef.current.getBoundingClientRect();
                let newX = (clientX - rect.left) / PIXELS_PER_METER - offset.x;
                let newY = (clientY - rect.top) / PIXELS_PER_METER - offset.y;
                const obj = objects.find(o => o.id === draggingId);
                newX = Math.max(0, Math.min(newX, siteConfig.width - obj.w));
                newY = Math.max(0, Math.min(newY, siteConfig.height - obj.h));
                setObjects(prev => prev.map(o => o.id === draggingId ? { ...o, x: newX, y: newY } : o));
            };

            const handleEnd = () => setDraggingId(null);
            const onMouseDown = (e, id) => handleStart(e.clientX, e.clientY, id, e);
            const onMouseMove = (e) => handleMove(e.clientX, e.clientY);
            const onTouchStart = (e, id) => handleStart(e.touches[0].clientX, e.touches[0].clientY, id, e);
            const onTouchMove = (e) => handleMove(e.touches[0].clientX, e.touches[0].clientY);
            
            const updateObject = (id, field, value) => {
                setObjects(prev => prev.map(o => o.id === id ? { ...o, [field]: value } : o));
            };
            const rotateObject = (id) => {
                setObjects(prev => prev.map(o => {
                    if (o.id !== id) return o;
                    return { ...o, w: o.h, h: o.w };
                }));
            };
            const deleteObject = (id) => {
                if (confirm('–£–¥–∞–ª–∏—Ç—å –æ–±—ä–µ–∫—Ç?')) {
                    setObjects(prev => prev.filter(o => o.id !== id));
                    if (selectedId === id) setSelectedId(null);
                }
            };
            const addObject = () => {
                const newId = 'obj_' + Date.now();
                setObjects([...objects, {
                    id: newId, label: '–ù–æ–≤—ã–π –æ–±—ä–µ–∫—Ç', w: 3, h: 3, height: 3,
                    x: siteConfig.width / 2 - 1.5, y: siteConfig.height / 2 - 1.5,
                    color: 'bg-yellow-100 border-yellow-500'
                }]);
                setSelectedId(newId);
            };

            // --- RENDER ---
            if (isLoading) return <div className="h-screen flex items-center justify-center text-gray-500">–ó–∞–≥—Ä—É–∑–∫–∞...</div>;

            return (
                <div className="flex flex-col h-screen overflow-hidden" onMouseUp={handleEnd} onMouseLeave={handleEnd} onTouchEnd={handleEnd}>
                    {/* –•–µ–¥–µ—Ä */}
                    <header className="bg-white border-b p-3 shadow-sm z-20 flex justify-between items-center h-14">
                        <div className="flex items-center gap-3">
                            <h1 className="text-lg font-bold text-gray-800 hidden md:block">3D –ü–ª–∞–Ω</h1>
                            
                            {/* –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä —Å—Ç–∞—Ç—É—Å–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è */}
                            {currentProjectId && (
                                <div className="flex items-center gap-2 bg-gray-100 px-3 py-1 rounded-full border">
                                    <input 
                                        value={projectName}
                                        onChange={(e) => setProjectName(e.target.value)}
                                        className="bg-transparent border-none text-sm font-bold w-32 focus:outline-none focus:ring-0 text-gray-700"
                                        placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–æ–µ–∫—Ç–∞"
                                    />
                                    {saveStatus === 'saved' && <span className="text-green-500 text-xs">‚úì –°–æ—Ö—Ä–∞–Ω–µ–Ω–æ</span>}
                                    {saveStatus === 'saving' && <span className="text-blue-500 text-xs">‚Üª –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ...</span>}
                                    {saveStatus === 'modified' && (
                                        <button onClick={saveProject} className="text-xs bg-blue-100 text-blue-700 px-2 py-0.5 rounded hover:bg-blue-200">
                                            –°–æ—Ö—Ä–∞–Ω–∏—Ç—å
                                        </button>
                                    )}
                                </div>
                            )}
                        </div>
                        
                        <div className="flex gap-2 items-center">
                            <div className="bg-gray-100 p-1 rounded-lg flex text-xs">
                                <button onClick={() => setViewMode('2d')} className={`px-3 py-1 rounded ${viewMode === '2d' ? 'bg-white shadow text-blue-600' : 'text-gray-500'}`}>2D</button>
                                <button onClick={() => setViewMode('3d')} className={`px-3 py-1 rounded ${viewMode === '3d' ? 'bg-white shadow text-blue-600' : 'text-gray-500'}`}>3D</button>
                            </div>
                            <button onClick={addObject} className="bg-blue-600 hover:bg-blue-700 text-white px-3 py-1.5 rounded shadow text-xs font-bold whitespace-nowrap">
                                + –û–±—ä–µ–∫—Ç
                            </button>
                        </div>
                    </header>

                    <div className="flex flex-1 overflow-hidden">
                        {/* –õ–µ–≤–∞—è –ø–∞–Ω–µ–ª—å */}
                        <div className="w-64 sm:w-80 bg-white border-r flex flex-col z-10 shadow-lg flex-shrink-0">
                            
                            {/* –°–µ–∫—Ü–∏—è –ø—Ä–æ–µ–∫—Ç–æ–≤ */}
                            <div className="p-4 border-b bg-gray-50">
                                <div className="flex justify-between items-center mb-2">
                                    <h3 className="font-bold text-gray-700 text-xs uppercase tracking-wide">–ú–æ–∏ –ü—Ä–æ–µ–∫—Ç—ã</h3>
                                    <button onClick={createNewProject} className="text-blue-600 text-xs hover:underline">+ –ù–æ–≤—ã–π</button>
                                </div>
                                <div className="max-h-32 overflow-y-auto space-y-1">
                                    {projects.length === 0 && <div className="text-gray-400 text-xs italic">–ù–µ—Ç –ø—Ä–æ–µ–∫—Ç–æ–≤. –°–æ–∑–¥–∞–π—Ç–µ –Ω–æ–≤—ã–π.</div>}
                                    {projects.map(p => (
                                        <div 
                                            key={p.id} 
                                            onClick={() => loadProject(p)}
                                            className={`group flex justify-between items-center px-2 py-1.5 rounded text-sm cursor-pointer border ${currentProjectId === p.id ? 'bg-blue-50 border-blue-200 text-blue-800' : 'bg-white border-transparent hover:bg-gray-100'}`}
                                        >
                                            <span className="truncate w-32">{p.name}</span>
                                            <button 
                                                onClick={(e) => deleteProject(p.id, e)}
                                                className="opacity-0 group-hover:opacity-100 text-gray-400 hover:text-red-500 px-1" title="–£–¥–∞–ª–∏—Ç—å"
                                            >√ó</button>
                                        </div>
                                    ))}
                                </div>
                            </div>

                            {/* –°–∫—Ä–æ–ª–ª –∫–æ–Ω—Ç–µ–Ω—Ç –Ω–∞—Å—Ç—Ä–æ–µ–∫ */}
                            <div className="flex-1 overflow-y-auto p-4 space-y-6">
                                {currentProjectId ? (
                                    <>
                                        {/* –†–∞–∑–º–µ—Ä—ã */}
                                        <div>
                                            <h3 className="font-bold text-gray-700 mb-2 text-xs">–†–ê–ó–ú–ï–†–´ –£–ß–ê–°–¢–ö–ê (–º)</h3>
                                            <div className="grid grid-cols-2 gap-2">
                                                <div>
                                                    <label className="text-[10px] text-gray-500">–®–∏—Ä–∏–Ω–∞</label>
                                                    <input type="number" value={siteConfig.width} onChange={(e) => setSiteConfig({...siteConfig, width: Number(e.target.value)})} className="w-full border rounded p-1 text-sm"/>
                                                </div>
                                                <div>
                                                    <label className="text-[10px] text-gray-500">–ì–ª—É–±–∏–Ω–∞</label>
                                                    <input type="number" value={siteConfig.height} onChange={(e) => setSiteConfig({...siteConfig, height: Number(e.target.value)})} className="w-full border rounded p-1 text-sm"/>
                                                </div>
                                            </div>
                                        </div>

                                        {/* –°–ø–∏—Å–æ–∫ –æ–±—ä–µ–∫—Ç–æ–≤ */}
                                        <div>
                                            <h3 className="font-bold text-gray-700 mb-2 text-xs">–û–ë–™–ï–ö–¢–´ –ù–ê –ü–õ–ê–ù–ï</h3>
                                            <div className="space-y-2">
                                                {objects.map(obj => (
                                                    <div key={obj.id} onClick={() => setSelectedId(obj.id)} className={`p-2 rounded border cursor-pointer text-sm transition ${selectedId === obj.id ? 'ring-2 ring-blue-500 bg-blue-50' : 'bg-white hover:border-blue-300'}`}>
                                                        <div className="flex justify-between mb-1">
                                                            <input value={obj.label} onChange={(e) => updateObject(obj.id, 'label', e.target.value)} className="font-bold bg-transparent border-b border-gray-300 w-24 text-xs focus:outline-none"/>
                                                            <button onClick={(e) => { e.stopPropagation(); deleteObject(obj.id); }} className="text-gray-400 hover:text-red-500">√ó</button>
                                                        </div>
                                                        <div className="grid grid-cols-3 gap-1">
                                                            <input type="number" value={obj.w} onChange={(e) => updateObject(obj.id, 'w', Number(e.target.value))} className="border rounded px-1 py-0.5 text-[10px]" title="–®–∏—Ä–∏–Ω–∞"/>
                                                            <input type="number" value={obj.h} onChange={(e) => updateObject(obj.id, 'h', Number(e.target.value))} className="border rounded px-1 py-0.5 text-[10px]" title="–î–ª–∏–Ω–∞"/>
                                                            <input type="number" value={obj.height} onChange={(e) => updateObject(obj.id, 'height', Number(e.target.value))} className="border rounded px-1 py-0.5 text-[10px] bg-blue-50 text-blue-700 font-bold" title="–í—ã—Å–æ—Ç–∞"/>
                                                        </div>
                                                        <button onClick={(e) => { e.stopPropagation(); rotateObject(obj.id); }} className="mt-1 w-full text-[10px] bg-gray-50 border hover:bg-gray-100 rounded py-0.5">‚Üª –ü–æ–≤–µ—Ä–Ω—É—Ç—å</button>
                                                    </div>
                                                ))}
                                            </div>
                                        </div>
                                    </>
                                ) : (
                                    <div className="text-center text-gray-400 mt-10">
                                        <p className="mb-2">–í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–æ–µ–∫—Ç —Å–ª–µ–≤–∞</p>
                                        <p className="text-xs">–∏–ª–∏ —Å–æ–∑–¥–∞–π—Ç–µ –Ω–æ–≤—ã–π</p>
                                    </div>
                                )}
                            </div>
                        </div>

                        {/* –ü—Ä–∞–≤–∞—è –ø–∞–Ω–µ–ª—å: –ö–∞–Ω–≤–∞—Å */}
                        <div className="flex-1 overflow-hidden bg-gray-100 relative" onMouseDown={() => setSelectedId(null)}>
                            {currentProjectId ? (
                                viewMode === '2d' ? (
                                    <div className="w-full h-full overflow-auto p-8 flex justify-center items-start">
                                        <div ref={containerRef} className="bg-white shadow-xl relative grid-pattern flex-shrink-0" 
                                            style={{ width: siteConfig.width * PIXELS_PER_METER, height: siteConfig.height * PIXELS_PER_METER, backgroundSize: `${PIXELS_PER_METER}px ${PIXELS_PER_METER}px` }}
                                            onMouseMove={onMouseMove} onTouchMove={onTouchMove}>
                                            
                                            {/* –õ–∏–Ω–µ–π–∫–∏ */}
                                            <div className="absolute -top-6 w-full text-center text-gray-500 text-sm">{siteConfig.width} –º</div>
                                            <div className="absolute -left-6 top-0 h-full flex items-center"><span className="text-gray-500 text-sm -rotate-90 whitespace-nowrap">{siteConfig.height} –º</span></div>

                                            {objects.map(obj => (
                                                <div key={obj.id}
                                                    onMouseDown={(e) => onMouseDown(e, obj.id)}
                                                    onTouchStart={(e) => onTouchStart(e, obj.id)}
                                                    className={`absolute border-2 flex flex-col items-center justify-center cursor-move select-none no-select shadow-sm hover:shadow-md transition-shadow ${obj.color} ${(draggingId === obj.id || selectedId === obj.id) ? 'z-50 ring-2 ring-blue-500 opacity-95' : 'z-10'}`}
                                                    style={{ width: obj.w * PIXELS_PER_METER, height: obj.h * PIXELS_PER_METER, left: obj.x * PIXELS_PER_METER, top: obj.y * PIXELS_PER_METER }}
                                                    title={obj.label}>
                                                    
                                                    {selectedId === obj.id && (
                                                        <>
                                                            <div className="absolute border-l border-red-500 border-dashed w-[1px]" style={{ height: obj.y * PIXELS_PER_METER, top: -obj.y * PIXELS_PER_METER, left: '50%' }}></div>
                                                            <div className="absolute bg-white px-1 text-[9px] font-bold text-red-600 rounded border border-red-200 z-50 shadow-sm" style={{ top: -obj.y * PIXELS_PER_METER / 2 - 8, left: '50%', transform: 'translateX(-50%)' }}>{obj.y.toFixed(1)}</div>
                                                            
                                                            <div className="absolute border-l border-red-500 border-dashed w-[1px]" style={{ height: (siteConfig.height - obj.y - obj.h) * PIXELS_PER_METER, bottom: -(siteConfig.height - obj.y - obj.h) * PIXELS_PER_METER, left: '50%' }}></div>
                                                            <div className="absolute bg-white px-1 text-[9px] font-bold text-red-600 rounded border border-red-200 z-50 shadow-sm" style={{ bottom: -(siteConfig.height - obj.y - obj.h) * PIXELS_PER_METER / 2 - 8, left: '50%', transform: 'translateX(-50%)' }}>{(siteConfig.height - obj.y - obj.h).toFixed(1)}</div>

                                                            <div className="absolute border-t border-red-500 border-dashed h-[1px]" style={{ width: obj.x * PIXELS_PER_METER, left: -obj.x * PIXELS_PER_METER, top: '50%' }}></div>
                                                            <div className="absolute bg-white px-1 text-[9px] font-bold text-red-600 rounded border border-red-200 z-50 shadow-sm" style={{ left: -obj.x * PIXELS_PER_METER / 2, top: '50%', transform: 'translate(-50%, -50%)' }}>{obj.x.toFixed(1)}</div>

                                                            <div className="absolute border-t border-red-500 border-dashed h-[1px]" style={{ width: (siteConfig.width - obj.x - obj.w) * PIXELS_PER_METER, right: -(siteConfig.width - obj.x - obj.w) * PIXELS_PER_METER, top: '50%' }}></div>
                                                            <div className="absolute bg-white px-1 text-[9px] font-bold text-red-600 rounded border border-red-200 z-50 shadow-sm" style={{ right: -(siteConfig.width - obj.x - obj.w) * PIXELS_PER_METER / 2, top: '50%', transform: 'translate(50%, -50%)' }}>{(siteConfig.width - obj.x - obj.w).toFixed(1)}</div>
                                                        </>
                                                    )}
                                                    
                                                    <div className="text-[10px] font-bold text-center leading-tight px-1 truncate w-full pointer-events-none">{obj.label}</div>
                                                    <div className="text-[9px] opacity-60 text-center hidden sm:block pointer-events-none">{obj.w}x{obj.h}</div>
                                                </div>
                                            ))}
                                        </div>
                                    </div>
                                ) : (
                                    <Scene3D objects={objects} siteConfig={siteConfig} />
                                )
                            ) : (
                                <div className="w-full h-full flex flex-col items-center justify-center text-gray-400">
                                    <span className="text-4xl mb-4">üèóÔ∏è</span>
                                    <p>–í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–æ–µ–∫—Ç –∏–ª–∏ —Å–æ–∑–¥–∞–π—Ç–µ –Ω–æ–≤—ã–π</p>
                                </div>
                            )}
                        </div>
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>